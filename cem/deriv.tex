\subsection{ベクトルヘルムホルツ方程式の導出}

文献Elmerでは$\frac{\partial}{\partial t}=-j\omega$としている。
本書では電磁気学では一般的な$\frac{\partial}{\partial t}=j\omega$とする。

マクスウェル方程式
\begin{align}
\nabla\times\vec{H}&=\vec{i}+j\omega\epsilon\vec{E}\label{fml:maxh}\\
\nabla\times\vec{E}&=-j\omega\mu\vec{H}\label{fml:maxe}
\end{align}

ここでマクスウェルの方程式の解説をしようか。
式(\ref{fml:maxh})は中学校で習ったなんとかの法則,
電流が方位磁針の針を動かすやつ。
式(\ref{fml:maxe})はやっぱり中学校で習った電磁誘導の法則。
$\epsilon$は高校で習った誘電率で,
真空では$8.854\times10^{-12}$[F/m]。
$\mu$は透磁率という値で,
大体の物質では$4\pi\times10^{-7}$(単位忘れた),
鉄などの磁性を持つ物質ではその数千倍以上となる。
また, 方向によって値が異なる場合があり,
一般には場所の関数である$3\times3$行列であらわされるテンソルとなる。
$\vec{i}$は電流減, とか, グダグダ書いているが, 表か箇条書きにすべきだな。

式(\ref{fml:maxh})の両辺に$-j\omega$,
式(\ref{fml:maxe})の両辺に$\mu^{-1}$ をかけて
\begin{align}
\nabla\times\left(-j\omega\vec{H}\right)
&=-j\omega\vec{i}+\omega^2\epsilon\vec{E}\\
\mu^{-1}\left(\nabla\times\vec{E}\right)
&=-j\omega\vec{H}
\end{align}
上の2式において$-j\omega\vec{H}$が共通なので
\begin{align}
\nabla\times\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]
&=-j\omega\vec{i}+\omega^2\epsilon\vec{E}\\
\nabla\times\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]-\omega^2\epsilon\vec{E}
&=-j\omega\vec{i}
\end{align}
となる。さらに, 媒質が導電率$\sigma$[S/m]を持つ場合,
$\vec{i}$を$\vec{i}+\sigma\vec{E}$とおいて,
\begin{align}
\nabla\times\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]-\omega^2\epsilon\vec{E}
&=-j\omega\left(\vec{i}+\sigma\vec{E}\right)\\
&=-j\omega\vec{i}+j\omega\sigma\vec{E}\\
\nabla\times\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]-\omega^2\epsilon\vec{E}-j\omega\sigma\vec{E}
&=-j\omega\vec{i}\\
\nabla\times\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]-\omega\left(\omega\epsilon+j\sigma\right)\vec{E}
&=-j\omega\vec{i}
\end{align}
と考えればよい。鉄損を考える場合は$\mu$を複素数とすればよい。

\subsection{弱形式の導出}

基底関数$v$をかけて体積分
文献 Nasa では edge basis function とあるので,
「基底関数」でよいだろう。「辺基底関数」とか言うか?
$N_i$ というか文献 Nasa 内では shape function と書いているが,
これがノードベースFEMの基底関数なんだよな。一気に書くのは大変だから,
分けて書くか。
\begin{align}
\iiint_\Omega\nabla\times\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]\cdot\vec{v}\,dx\,dy\,dz
\end{align}
ベクトル解析の公式
$\left(\nabla\times\vec{a}\right)\cdot\vec{b}
=\nabla\cdot\left(\vec{a}\times\vec{b}\right)
+\left(\nabla\times\vec{b}\right)\cdot\vec{a}$
に$\vec{a}=\mu^{-1}\left(\nabla\times\vec{E}\right)$, $\vec{b}=\vec{v}$
を適用して
\begin{align}
(\textrm{与式})&=
\iiint_\Omega\nabla\cdot
\left\{\left[\mu^{-1}
\left(\nabla\times\vec{E}\right)
\right]\times\vec{v}\right\}\,dx\,dy\,dz\\
&+\iiint_\Omega\left[\mu^{-1}\left(\nabla\times\vec{E}\right)\right]\cdot
\left(\nabla\times\vec{v}\right)\,dx\,dy\,dz
\end{align}
第1項にガウスの発散定理を適用して
\begin{align}
&\iiint_{\Omega}\nabla\cdot
\left\{\left[\mu^{-1}\left(\nabla\times\vec{E}\right)\right]\times\vec{v}\right\}
\,dx\,dy\,dz\\
=&\iint_\Gamma
\left\{\left[
\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]\times\vec{v}\right\}\cdot\hat{n}
\,d\Gamma
\end{align}
ベクトル解析の公式
$\left(\vec{a}\times\vec{b}\right)\cdot\vec{c}
=\left(\vec{b}\times\vec{c}\right)\cdot\vec{a}$
に
$\vec{a}=\mu^{-1}\left(\nabla\times\vec{E}\right),
 \vec{b}=\vec{v}, \vec{c}=\hat{n}$
を適用して
\begin{align}
\iint_\Gamma
\left(\vec{v}\times\hat{n}\right)\cdot
\left[\mu^{-1}\left(\nabla\times\vec{E}\right)
\right]\,d\Gamma
\end{align}

\begin{align}
\nabla\times\vec{E}=-j\omega\mu\vec{H}
\end{align}

境界で無反射とすると
\begin{align}
\vec{E}\times\hat{n}=&-\sqrt\frac{\mu}{\epsilon}\vec{H}
\end{align}
両辺に$j\omega\sqrt{\epsilon\mu}$をかけて
\begin{align}
j\omega\sqrt{\epsilon\mu}\left(\vec{E}\times\hat{n}\right)=&-j\omega\mu\vec{H}
\end{align}

境界面積分項は
\begin{align}
j\omega\iint_\Gamma
\left(\vec{v}\times\hat{n}\right)\cdot
\left[\mu^{-1}
\sqrt{\epsilon\mu}\left(\vec{E}\times\hat{n}\right)
\right]\,d\Gamma
\end{align}
となる。多分、この境界積分項に現れる$\epsilon$と$\mu$
は領域外物質のもので,
そこでテンソルを考えると解が波動なのかどうかあやしくなくので%
この時点でスカラとしてよいだろう。
\begin{align}
j\omega\iint_\Gamma\sqrt\frac{\epsilon}{\mu}
\left(\vec{v}\times\hat{n}\right)\cdot
\left(\vec{E}\times\hat{n}\right)
\,d\Gamma
\end{align}

\subsection{回転項の積分}

$v_i$とか、とにかく$v$, $V$
は電圧のために空けておきたいので
$\bm{W}_i$を基底関数に使用する。

\begin{align}
&\nabla\times\bm{W}_{ij}\\
=&\nabla\times\left(N_i\nabla N_j-N_j\nabla N_i\right)\\
=&\nabla\times\left(N_i\nabla N_j\right)
 -\nabla\times\left(N_j\nabla N_i\right)
\end{align}
第一項に公式
$\nabla\times\left(f\bm{a}\right)
=\left(\nabla f\right)\times\bm{a}
+f\left(\nabla\times\bm{a}\right)$
を適用し,
$\left(f, \bm{a}\right)
=\left(N_i, \nabla N_j\right)$
とすると,
\begin{align}
\nabla N_i\times\nabla N_j
+\nabla N_i\left[\nabla\times\left(\nabla N_j\right)\right]
\end{align}
第二項に公式
$\nabla\times\left(\nabla f\right)=\bm{0}$
を適用し
$f=N_j$とすると,
\begin{align}
\nabla N_i\times\nabla N_j
\end{align}
だけが残る。もう一方の項も同様に
\begin{align}
-\nabla N_j\times\nabla N_i = \nabla N_i\times\nabla N_j
\end{align}
となるので, 和は
\begin{align}
2\nabla N_i\times\nabla N_j
\end{align}
である。

\begin{align}
&\left(\nabla\times\bm{W}_{ij}\right)\cdot
\left(\nabla\times\bm{W}_{kl}\right)\\
=&4\left(\nabla N_i\times\nabla N_j\right)\cdot
   \left(\nabla N_k\times\nabla N_l\right)
\end{align}

積分すると$\left|\Gamma\right|$倍になる。

\subsection{境界積分項}

\begin{align}
\hat{n}&=\frac{
\bm{q}_1\times\bm{q}_2
}{
\left|\bm{q}_1\times\bm{q}_2\right|
}\\
&=\frac{\bm{q}_1\times\bm{q}_2}{2\left|\Gamma_3\right|}
\end{align}

\begin{align}
&\bm{W}_{ij}\times\hat{n}\\
=&\left(N_i\nabla N_j-N_j\nabla N_i\right)\times\hat{n}\\
=&N_i\left[\left(\nabla N_j\right)\times\hat{n}\right]
 -N_j\left[\left(\nabla N_i\right)\times\hat{n}\right]
\end{align}

\begin{align}
\nabla N_1 = \frac{\bm{q}_2\times\bm{q}_3}{6\left|\Omega_m\right|}
\end{align}

\begin{align}
12\left|\Omega_m\right|\left|\Gamma_3\right|\nabla N_1\times\hat{n}
&=\left(\bm{q}_2\times\bm{q}_3\right)\times\left(\bm{q}_1\times\bm{q}_2\right)
\end{align}

公式
$\bm{a}\times\left(\bm{b}\times\bm{c}\right)
=\bm{b}\left(\bm{a}\cdot\bm{c}\right)
-\bm{c}\left(\bm{a}\cdot\bm{b}\right)$
で
$\bm{a}=\bm{q}_2\times\bm{q}_3$, $\bm{b}=\bm{q}_1$, $\bm{c}=\bm{q}_2$
と考えて
\begin{align}
12\left|\Omega_m\right|\left|\Gamma_3\right|\nabla N_1\times\hat{n}
&=\bm{q}_1\left[\left(\bm{q}_2\times\bm{q}_3\right)\cdot\bm{q}_2\right]
 -\bm{q}_2\left[\left(\bm{q}_2\times\bm{q}_3\right)\cdot\bm{q}_1\right]\\
&=-\bm{q}_2\cdot6\left|\Omega_m\right|\\
2\left|\Gamma_3\right|\nabla N_1\times\hat{n}
&=-\bm{q}_2
\end{align}

\begin{align}
\nabla N_2 = \frac{\bm{q}_3\times\bm{q}_1}{6\left|\Omega_m\right|}
\end{align}

\begin{align}
12\left|\Omega_m\right|\left|\Gamma_3\right|\nabla N_2\times\hat{n}
&=\left(\bm{q}_3\times\bm{q}_1\right)\times\left(\bm{q}_1\times\bm{q}_2\right)
\end{align}

公式
$\bm{a}\times\left(\bm{b}\times\bm{c}\right)
=\bm{b}\left(\bm{a}\cdot\bm{c}\right)
-\bm{c}\left(\bm{a}\cdot\bm{b}\right)$
で
$\bm{a}=\bm{q}_3\times\bm{q}_1$, $\bm{b}=\bm{q}_1$, $\bm{c}=\bm{q}_2$
と考えて
\begin{align}
12\left|\Omega_m\right|\left|\Gamma_3\right|\nabla N_2\times\hat{n}
&=\bm{q}_1\left[\left(\bm{q}_3\times\bm{q}_1\right)\cdot\bm{q}_2\right]
 -\bm{q}_2\left[\left(\bm{q}_3\times\bm{q}_1\right)\cdot\bm{q}_1\right]\\
&=\bm{q}_1\cdot6\left|\Omega_m\right|\\
2\left|\Gamma_3\right|\nabla N_2\times\hat{n}
&=\bm{q}_1
\end{align}

明らかに
\begin{align}
12\left|\Omega_m\right|\left|\Gamma_3\right|\nabla N_3\times\hat{n}
&=\left(\bm{q}_1\times\bm{q}_2\right)\times\left(\bm{q}_1\times\bm{q}_2\right)\\
&=\bm{0}
\end{align}

\begin{align}
2\left|\Gamma_3\right|\nabla N_0\times\hat{n}
&=2\left|\Gamma_3\right|
 \left(-\nabla N_1-\nabla N_2-\nabla N_3\right)\times\hat{n}\\
&=\bm{q}_2-\bm{q}_1
\end{align}

これは結局2次元の三角形上に定義した $N_0$, $N_1$, $N_2$
をから求めた $\nabla N_0$, $\nabla N_1$, $\nabla N_2$
を $90^\circ$ 回転させたものになっている。
ということで, 乱暴に2次元励起を書く。
きれいな論理展開にするのは後回し。

\subsection{2次元励起}

\begin{align}
\iint\bm{i}\cdot\bm{W}\,dS
\end{align}

\begin{align}
\bm{i}\cdot\left(N_k\nabla N_l-N_l\nabla N_k\right)
\end{align}

\begin{align}
2\left|\Gamma_3\right|\bm{i}\cdot\nabla N_0
&=\bm{i}\cdot\left(\bm{q}_2-\bm{q}_1\right)\\
2\left|\Gamma_3\right|\bm{i}\cdot\nabla N_1
&=-\bm{i}\cdot\bm{q}_2\\
2\left|\Gamma_3\right|\bm{i}\cdot\nabla N_2
&=\bm{i}\cdot\bm{q}_1
\end{align}

あとは。メッシュ内で $\bm{i}$ 一定とする。
\begin{align}
\iint N_k\,dS = \left|\Gamma_3\right|
\end{align}

あとは。$\bm{i}$ に $\left(\bm{q}_1\times\bm{q}_2\right)$
を右から外積しないとなぁ。なんか文章で書くのが難しい。
ユーザー指定値の中で面に平行でない成分は無視する,
とか書くんだろうな。